name: 'Notify Squad'
description: 'Send Slack notification to relevant squad about PR status'
inputs:
  github-token:
    description: 'GitHub token for API access'
    required: true
  pr-number:
    description: 'Pull request number'
    required: true
  pr-title:
    description: 'Pull request title'
    required: true
  pr-author:
    description: 'Pull request author'
    required: true
  pr-url:
    description: 'Pull request URL'
    required: true
  category-size:
    description: 'PR size category (small/medium/large)'
    required: true
  category-type:
    description: 'PR type category (docs/bugfix/refactor/feature)'
    required: true
  stage:
    description: 'Review stage (early-alignment/validation-passed/ready-for-review)'
    required: true
  validation-status:
    description: 'Validation status (passed/failed/pending)'
    required: false
    default: 'pending'
  ai-review-summary:
    description: 'AI review summary'
    required: false
    default: 'Pending'
outputs:
  notification-sent:
    description: 'Whether notification was successfully sent'
    value: ${{ steps.notify.outputs.notification-sent }}

runs:
  using: 'composite'
  steps:
    - name: Determine squad and webhook
      id: determine-squad
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github-token }}
        PR_NUMBER: ${{ inputs.pr-number }}
      run: |
        # Get changed files
        changed_files=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path' | tr '\n' ',')
        
        # Get labels
        labels=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name' | tr '\n' ',')
        
        # Load squad mapping
        squad_config=$(cat .github/squad-mapping.json)
        
        # Try to match squad by labels first
        squad_name=""
        webhook_secret=""
        channel=""
        
        # Check each squad
        for squad in $(echo "$squad_config" | jq -r '.squads[] | @base64'); do
          _jq() {
            echo "$squad" | base64 --decode | jq -r "$1"
          }
          
          squad_labels=$(_jq '.labels | join(",")')
          
          # Check if any squad label matches PR labels
          for label in $(echo "$squad_labels" | tr ',' '\n'); do
            if echo "$labels" | grep -q "$label"; then
              squad_name=$(_jq '.name')
              webhook_secret=$(_jq '.slack_webhook_secret')
              channel=$(_jq '.slack_channel')
              break 2
            fi
          done
        done
        
        # If no squad found by label, use default
        if [ -z "$squad_name" ]; then
          squad_name=$(echo "$squad_config" | jq -r '.default_squad.name')
          webhook_secret=$(echo "$squad_config" | jq -r '.default_squad.slack_webhook_secret')
          channel=$(echo "$squad_config" | jq -r '.default_squad.slack_channel')
        fi
        
        echo "squad-name=$squad_name" >> "$GITHUB_OUTPUT"
        echo "webhook-secret=$webhook_secret" >> "$GITHUB_OUTPUT"
        echo "channel=$channel" >> "$GITHUB_OUTPUT"
        
        echo "âœ… Determined squad: $squad_name ($channel)"

    - name: Build Slack message
      id: build-message
      shell: bash
      env:
        PR_TITLE: ${{ inputs.pr-title }}
        PR_AUTHOR: ${{ inputs.pr-author }}
        PR_URL: ${{ inputs.pr-url }}
        PR_NUMBER: ${{ inputs.pr-number }}
        SIZE: ${{ inputs.category-size }}
        TYPE: ${{ inputs.category-type }}
        STAGE: ${{ inputs.stage }}
        VALIDATION_STATUS: ${{ inputs.validation-status }}
        AI_SUMMARY: ${{ inputs.ai-review-summary }}
        SQUAD: ${{ steps.determine-squad.outputs.squad-name }}
        CHANNEL: ${{ steps.determine-squad.outputs.channel }}
      run: |
        # Size emoji
        case "$SIZE" in
          small) SIZE_EMOJI="ðŸŸ¢" ;;
          medium) SIZE_EMOJI="ðŸŸ¡" ;;
          large) SIZE_EMOJI="ðŸ”´" ;;
        esac
        
        # Type emoji
        case "$TYPE" in
          docs) TYPE_EMOJI="ðŸ“" ;;
          bugfix) TYPE_EMOJI="ðŸ›" ;;
          refactor) TYPE_EMOJI="ðŸ”¨" ;;
          feature) TYPE_EMOJI="âœ¨" ;;
        esac
        
        # Stage-specific messaging
        case "$STAGE" in
          early-alignment)
            STAGE_TEXT="ðŸš¦ *Early Alignment Required*"
            MESSAGE="A Large PR needs early human review before automated validation."
            ;;
          validation-passed)
            STAGE_TEXT="âœ… *Ready for Review*"
            MESSAGE="All automated checks have passed. PR is ready for human review."
            ;;
          ready-for-review)
            STAGE_TEXT="ðŸ‘€ *Review Needed*"
            MESSAGE="PR has completed validation and is awaiting review."
            ;;
          *)
            STAGE_TEXT="ðŸ“¢ *New PR*"
            MESSAGE="A new external PR has been submitted."
            ;;
        esac
        
        # Validation status
        case "$VALIDATION_STATUS" in
          passed) VAL_TEXT="âœ… Passed" ;;
          failed) VAL_TEXT="âŒ Failed" ;;
          *) VAL_TEXT="â³ Pending" ;;
        esac
        
        # Build Slack payload
        cat > slack_payload.json << EOF
        {
          "channel": "$CHANNEL",
          "username": "PR Automation Bot",
          "icon_emoji": ":grafana:",
          "text": "$STAGE_TEXT: External PR #$PR_NUMBER",
          "blocks": [
            {
              "type": "header",
              "text": {
                "type": "plain_text",
                "text": "$STAGE_TEXT"
              }
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*PR:* <$PR_URL|#$PR_NUMBER: $PR_TITLE>\n*Author:* $PR_AUTHOR\n*Squad:* $SQUAD"
              }
            },
            {
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Category:*\n$SIZE_EMOJI $SIZE | $TYPE_EMOJI $TYPE"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Validation:*\n$VAL_TEXT"
                }
              ]
            },
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "*AI Review:* $AI_SUMMARY"
              }
            },
            {
              "type": "context",
              "elements": [
                {
                  "type": "mrkdwn",
                  "text": "$MESSAGE"
                }
              ]
            },
            {
              "type": "actions",
              "elements": [
                {
                  "type": "button",
                  "text": {
                    "type": "plain_text",
                    "text": "View PR"
                  },
                  "url": "$PR_URL",
                  "style": "primary"
                }
              ]
            }
          ]
        }
        EOF
        
        echo "âœ… Built Slack message"

    - name: Send Slack notification
      id: notify
      shell: bash
      env:
        WEBHOOK_SECRET_NAME: ${{ steps.determine-squad.outputs.webhook-secret }}
      run: |
        # Get webhook URL from secrets (this will be set by repository admin)
        # For now, just log that notification would be sent
        
        webhook_url="${!WEBHOOK_SECRET_NAME}"
        
        if [ -z "$webhook_url" ]; then
          echo "âš ï¸ Slack webhook not configured for secret: $WEBHOOK_SECRET_NAME"
          echo "notification-sent=false" >> "$GITHUB_OUTPUT"
          echo ""
          echo "To enable Slack notifications:"
          echo "1. Create a Slack webhook for your channel"
          echo "2. Add it as a repository secret named: $WEBHOOK_SECRET_NAME"
          echo "3. Notifications will be sent automatically"
          exit 0
        fi
        
        # Send notification
        response=$(curl -s -X POST "$webhook_url" \
          -H "Content-Type: application/json" \
          -d @slack_payload.json)
        
        if echo "$response" | grep -q "ok"; then
          echo "âœ… Slack notification sent successfully"
          echo "notification-sent=true" >> "$GITHUB_OUTPUT"
        else
          echo "âŒ Failed to send Slack notification: $response"
          echo "notification-sent=false" >> "$GITHUB_OUTPUT"
        fi

