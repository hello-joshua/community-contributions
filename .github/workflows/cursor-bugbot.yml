name: Cursor Bugbot Review

on:
  workflow_dispatch:
    inputs:
      pr-number:
        description: 'PR number to review'
        required: true
        type: number
      review-depth:
        description: 'Review depth'
        required: true
        type: choice
        options:
          - lightweight
          - thorough
  workflow_call:
    inputs:
      pr-number:
        description: 'PR number to review'
        required: true
        type: number
      review-depth:
        description: 'Review depth (lightweight/thorough)'
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  bugbot-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Get PR details
        id: pr-details
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr-number }}
        run: |
          # Get PR diff
          gh pr diff "$PR_NUMBER" > pr_diff.txt
          
          # Get PR metadata
          pr_title=$(gh pr view "$PR_NUMBER" --json title --jq '.title')
          pr_body=$(gh pr view "$PR_NUMBER" --json body --jq '.body')
          
          echo "pr-title=$pr_title" >> "$GITHUB_OUTPUT"
          echo "pr-body<<EOF" >> "$GITHUB_OUTPUT"
          echo "$pr_body" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Configure review focus
        id: configure
        env:
          REVIEW_DEPTH: ${{ inputs.review-depth }}
        run: |
          if [ "$REVIEW_DEPTH" = "lightweight" ]; then
            FOCUS="Focus on: critical bugs, security issues, architectural concerns. Ignore style and minor issues."
            echo "focus=$FOCUS" >> "$GITHUB_OUTPUT"
          elif [ "$REVIEW_DEPTH" = "thorough" ]; then
            FOCUS="Perform thorough code review: bugs, security, best practices, code quality, maintainability, testing."
            echo "focus=$FOCUS" >> "$GITHUB_OUTPUT"
          else
            FOCUS="Review for bugs and security issues."
            echo "focus=$FOCUS" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Cursor Bugbot
        id: bugbot
        continue-on-error: true
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_BUGBOT_TOKEN }}
          PR_NUMBER: ${{ inputs.pr-number }}
          REVIEW_FOCUS: ${{ steps.configure.outputs.focus }}
        run: |
          # Note: This is a placeholder for Cursor's Bugbot integration
          # The actual implementation will depend on Cursor's API/CLI
          
          echo "Starting Cursor Bugbot review..."
          echo "Review depth: ${{ inputs.review-depth }}"
          echo "Focus: $REVIEW_FOCUS"
          
          # Example: Using Cursor CLI (adjust based on actual API)
          # cursor-bugbot review --pr "$PR_NUMBER" --focus "$REVIEW_FOCUS" --output bugbot_results.json
          
          # For now, create a mock result to demonstrate the workflow
          cat > bugbot_results.json << 'EOF'
          {
            "status": "completed",
            "findings": [],
            "summary": "Bugbot review integration pending. Please configure CURSOR_BUGBOT_TOKEN secret.",
            "severity": "info"
          }
          EOF
          
          # Check if Cursor token is configured
          if [ -z "$CURSOR_API_KEY" ]; then
            echo "WARNING: CURSOR_BUGBOT_TOKEN not configured. Skipping AI review."
            echo "bugbot-status=skipped" >> "$GITHUB_OUTPUT"
          else
            echo "Bugbot review completed"
            echo "bugbot-status=completed" >> "$GITHUB_OUTPUT"
          fi
          
          # Parse results
          findings_count=$(jq '.findings | length' bugbot_results.json)
          summary=$(jq -r '.summary' bugbot_results.json)
          
          echo "findings-count=$findings_count" >> "$GITHUB_OUTPUT"
          echo "summary=$summary" >> "$GITHUB_OUTPUT"

      - name: Post Bugbot results
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ inputs.pr-number }}
          BUGBOT_STATUS: ${{ steps.bugbot.outputs.bugbot-status }}
          FINDINGS_COUNT: ${{ steps.bugbot.outputs.findings-count }}
          SUMMARY: ${{ steps.bugbot.outputs.summary }}
          REVIEW_DEPTH: ${{ inputs.review-depth }}
        run: |
          if [ "$BUGBOT_STATUS" = "skipped" ]; then
            COMMENT="## AI Code Review - Configuration Needed

Cursor's Bugbot review was skipped because the \`CURSOR_BUGBOT_TOKEN\` secret is not configured.

**For repository administrators**: 
1. Obtain a Cursor Bugbot API token
2. Add it as a repository secret named \`CURSOR_BUGBOT_TOKEN\`
3. Re-trigger this workflow

**For now**, proceeding without AI code review. Human review will be the primary validation."
          
          elif [ "$FINDINGS_COUNT" -eq 0 ]; then
            COMMENT="## AI Code Review Complete

**Review Type**: $REVIEW_DEPTH

**Result**: No critical issues found!

$SUMMARY

**Note**: This is an AI-assisted review. Human review is still required for final approval."
          
          else
            COMMENT="## AI Code Review Complete

**Review Type**: $REVIEW_DEPTH

**Findings**: $FINDINGS_COUNT issue(s) identified

$SUMMARY

Please review the detailed comments below and address the identified issues.

**Note**: This is an AI-assisted review. Some findings may be false positives - use your judgment."
          fi
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"

      - name: Set check status
        env:
          BUGBOT_STATUS: ${{ steps.bugbot.outputs.bugbot-status }}
          FINDINGS_COUNT: ${{ steps.bugbot.outputs.findings-count }}
        run: |
          if [ "$BUGBOT_STATUS" = "skipped" ]; then
            echo "WARNING: Bugbot skipped - configuration needed"
            exit 0
          elif [ "$FINDINGS_COUNT" -eq 0 ]; then
            echo "No critical issues found"
            exit 0
          else
            echo "WARNING: $FINDINGS_COUNT findings - please review"
            exit 0
          fi

