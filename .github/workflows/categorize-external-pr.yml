name: Categorize External PR

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited

permissions:
  pull-requests: write
  contents: read

jobs:
  categorize:
    name: Categorize PR by Size and Type
    # Only run for external contributors
    if: github.event.pull_request.author_association != 'MEMBER' && github.event.pull_request.author_association != 'OWNER'
    runs-on: ubuntu-latest
    
    steps:
      - name: Add external PR label
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "pr/external"
          echo "‚úÖ Added pr/external label"

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Run categorization
        id: categorize
        uses: ./.github/actions/categorize-pr
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-body: ${{ github.event.pull_request.body }}

      - name: Apply category labels
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SIZE_LABEL: ${{ steps.categorize.outputs.size-label }}
          TYPE_LABEL: ${{ steps.categorize.outputs.type-label }}
        run: |
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$SIZE_LABEL"
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$TYPE_LABEL"
          echo "‚úÖ Applied labels: $SIZE_LABEL, $TYPE_LABEL"

      - name: Post comprehensive categorization comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SIZE: ${{ steps.categorize.outputs.size }}
          TYPE: ${{ steps.categorize.outputs.type }}
          CONFLICT: ${{ steps.categorize.outputs.conflict }}
        run: |
          # Determine emoji and description based on size
          case "$SIZE" in
            small)
              SIZE_EMOJI="üü¢"
              SIZE_DESC="Small"
              SIZE_CRITERIA="< 100 lines changed, 1-3 files"
              EXPECTED_FLOW="### ‚ö° What happens next for Small PRs:

1. **Automated Validation** (~ 2-5 minutes)
   - ‚úÖ Linting and code formatting checks
   - ‚úÖ Verify tests exist for changed code
   - ‚úÖ Run relevant test suites
   - ‚úÖ Check PR requirements (description, issue reference, etc.)

2. **AI Code Review** (~ 1-2 minutes)
   - ü§ñ Lightweight review focusing on critical bugs and security issues
   - üí° Suggestions for obvious improvements
   - ‚ö†Ô∏è Flags potential problems

3. **Human Review** (hours to 1-2 days)
   - üë§ Final approval from a maintainer
   - üí¨ Any clarifying questions
   - ‚úÖ Merge when approved!

**Timeline**: Most Small PRs are reviewed within 1-2 days."
              TIPS="### üí° Tips for Small PRs:
- Run tests locally before pushing
- Ensure code follows style guidelines
- Keep description clear and concise
- Respond promptly to any feedback"
              ;;
            medium)
              SIZE_EMOJI="üü°"
              SIZE_DESC="Medium"
              SIZE_CRITERIA="100-500 lines changed, 4-10 files"
              EXPECTED_FLOW="### üìã What happens next for Medium PRs:

1. **Comprehensive Validation** (~ 5-10 minutes)
   - ‚úÖ Full linting and type checking
   - ‚úÖ Verify comprehensive test coverage
   - ‚úÖ Run complete test suite
   - ‚úÖ Validate all PR requirements

2. **Thorough AI Code Review** (~ 3-5 minutes)
   - ü§ñ In-depth code analysis
   - üîç Best practices validation
   - üõ°Ô∏è Security and performance review
   - üìù Detailed feedback and suggestions

3. **Squad Routing & Human Review** (2-5 days)
   - üë• Routed to relevant squad automatically
   - üí¨ Detailed code review by team members
   - üîÑ May require iterations
   - ‚úÖ Human approval required before merge

**Timeline**: Medium PRs typically take 2-5 days for full review."
              TIPS="### üí° Tips for Medium PRs:
- Ensure comprehensive test coverage
- Document complex logic
- Break into smaller commits if possible
- Be prepared for detailed feedback"
              ;;
            large)
              SIZE_EMOJI="üî¥"
              SIZE_DESC="Large"
              SIZE_CRITERIA="> 500 lines changed, > 10 files"
              EXPECTED_FLOW="### üö¶ What happens next for Large PRs:

**IMPORTANT**: Large PRs follow a different process to ensure your effort is well-directed!

#### Phase 1: Early Human Alignment (FIRST)
1. üë• **Squad notified immediately** for early review
2. ü§ù **Human reviewer checks your approach** before automation runs
3. üí¨ **Discussion about implementation strategy**
4. ‚úÖ **Alignment approval** when approach is confirmed

**‚ö†Ô∏è Please wait for alignment approval before investing more effort!**

#### Phase 2: Automated Validation (AFTER alignment)
5. ‚úÖ Basic validation checks
6. üß™ Smoke tests
7. ü§ñ Lightweight AI review (architecture focus)

#### Phase 3: Detailed Human Review
8. üë• In-depth code review by squad
9. üîÑ Iterative improvements
10. ‚úÖ Final approval and merge

**Timeline**: Large PRs typically take 1-2 weeks or more. The early alignment step helps avoid wasted effort on misaligned implementations."
              TIPS="### üí° Tips for Large PRs:
- **Wait for alignment approval** before extensive work
- Consider breaking into smaller PRs if possible
- Include high-level design notes
- Document architectural decisions
- Be very responsive to early feedback"
              ;;
          esac
          
          # Type description
          case "$TYPE" in
            docs)
              TYPE_EMOJI="üìù"
              TYPE_DESC="Documentation"
              TYPE_INFO="Changes to documentation, guides, or comments"
              ;;
            bugfix)
              TYPE_EMOJI="üêõ"
              TYPE_DESC="Bug Fix"
              TYPE_INFO="Fixes for existing issues or problems"
              ;;
            refactor)
              TYPE_EMOJI="üî®"
              TYPE_DESC="Refactor"
              TYPE_INFO="Code reorganization without changing functionality"
              ;;
            feature)
              TYPE_EMOJI="‚ú®"
              TYPE_DESC="Feature"
              TYPE_INFO="New functionality or enhancements"
              ;;
          esac
          
          # Build comprehensive comment
          COMMENT="# ü§ñ Automated PR Analysis

Thank you for your contribution to Grafana! Your PR has been analyzed and categorized.

---

## üìä PR Categorization

| Category | Value | Details |
|----------|-------|---------|
| **Size** | $SIZE_EMOJI **$SIZE_DESC** | $SIZE_CRITERIA |
| **Type** | $TYPE_EMOJI **$TYPE_DESC** | $TYPE_INFO |

$EXPECTED_FLOW

---

## ‚úÖ Validation Requirements

Your PR will be checked for:
- **Tests**: All changed code must have corresponding tests
- **Linting**: Code must pass style and format checks
- **Description**: Clear explanation of changes
- **Issue Reference**: Link to related issue (if applicable)
- **Commit Format**: Follow \`Area: Description\` format

$TIPS

---

## üìö Additional Resources

- [Contributing Guidelines](../contribute/create-pull-request.md) - Full contribution guide
- [External PR Workflow](../contribute/external-pr-workflow.md) - Detailed workflow explanation
- [Style Guides](../contribute/style-guides/) - Code style requirements

---

## üÜò Need Help?

- **Questions about this workflow?** Comment on this PR
- **General contribution questions?** Join our [community Slack](https://grafana.com/slack)
- **Found a bug in the automation?** Let us know in the comments"

          # Add conflict warning if present
          if [ "$CONFLICT" = "true" ]; then
            COMMENT="$COMMENT

---

‚ö†Ô∏è **Auto-Detection Override**

Our automation detected a different size category than what may have been indicated. The categorization above is based on:
- **Lines changed**: Actual code changes analyzed
- **Files modified**: Number of files touched
- **Complexity**: Overall impact assessment

This helps ensure appropriate review depth for your changes."
          fi
          
          COMMENT="$COMMENT

---

*This analysis was generated automatically by the Grafana PR automation system. The validation workflow will begin shortly.*"
          
          # Post comment
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"
          echo "‚úÖ Posted comprehensive categorization comment"

