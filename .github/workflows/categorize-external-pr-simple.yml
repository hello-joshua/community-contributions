name: Categorize External PR (Simple)

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited
      - labeled

permissions:
  pull-requests: write
  contents: read

jobs:
  categorize:
    name: Categorize PR by Size and Type
    # Only run for your collaborator bot account, not random external PRs
    if: github.event.pull_request.user.login == 'hello-joshua'
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if human changed labels
        id: check_human
        if: github.event.action == 'labeled'
        run: |
          if [ "${{ github.actor }}" != "github-actions[bot]" ]; then
            echo "human_change=true" >> "$GITHUB_OUTPUT"
            echo "Human (${{ github.actor }}) changed labels - trusting their judgment"
          else
            echo "human_change=false" >> "$GITHUB_OUTPUT"
            echo "Bot changed labels - will recategorize"
          fi

      - name: Post human correction acknowledgment
        if: steps.check_human.outputs.human_change == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ACTOR: ${{ github.actor }}
        run: |
          {
            echo "## Labels updated by maintainer"
            echo ""
            echo "Thank you @$ACTOR for updating the labels. The appropriate validation workflow will now run based on the current classification."
          } > /tmp/human-update.md
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body-file /tmp/human-update.md
          echo "Acknowledged human label change"

      - name: Checkout repository
        if: steps.check_human.outputs.human_change != 'true'
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            .github/actions
            .github/scripts
          sparse-checkout-cone-mode: false
          persist-credentials: false

      - name: Categorize PR
        if: steps.check_human.outputs.human_change != 'true'
        id: categorize
        uses: ./.github/actions/categorize-pr
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-body: ${{ github.event.pull_request.body }}
          openai-api-key: ${{ secrets.OPEN_AI_KEY }}

      - name: Debug categorization output
        if: steps.check_human.outputs.human_change != 'true'
        run: |
          echo "size=${{ steps.categorize.outputs.size }}"
          echo "size-label=${{ steps.categorize.outputs.size-label }}"
          echo "type=${{ steps.categorize.outputs.type }}"
          echo "type-label=${{ steps.categorize.outputs.type-label }}"

      - name: Apply labels
        if: steps.check_human.outputs.human_change != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SIZE_LABEL: ${{ steps.categorize.outputs.size-label }}
          TYPE_LABEL: ${{ steps.categorize.outputs.type-label }}
        run: |
          # Validate labels are set
          if [ -z "$SIZE_LABEL" ] || [ -z "$TYPE_LABEL" ]; then
            echo "ERROR: Labels not set. SIZE_LABEL='$SIZE_LABEL', TYPE_LABEL='$TYPE_LABEL'"
            exit 1
          fi
          
          echo "Will apply: $SIZE_LABEL, $TYPE_LABEL"
          
          # Remove old category and size labels before applying new ones
          existing_labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          
          for label in $existing_labels; do
            if [[ "$label" =~ ^(pr-category:|size:|type/bug$|type/feature$|type/docs$) ]]; then
              echo "Removing old label: $label"
              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --remove-label "$label" || true
            fi
          done
          
          # Apply new labels
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$SIZE_LABEL"
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$TYPE_LABEL"
          echo "Applied labels: $SIZE_LABEL, $TYPE_LABEL"

      - name: Post automated comment
        if: github.event.action != 'labeled' && steps.check_human.outputs.human_change != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/post-pr-comment.sh
          .github/scripts/post-pr-comment.sh \
            "${{ github.event.pull_request.number }}" \
            "${{ steps.categorize.outputs.size }}" \
            "${{ steps.categorize.outputs.type }}" \
            "${{ github.repository }}"
          echo "PR categorized and comment posted"

      - name: Post label update confirmation
        if: github.event.action == 'labeled' && steps.check_human.outputs.human_change != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TYPE: ${{ steps.categorize.outputs.type }}
          SIZE: ${{ steps.categorize.outputs.size }}
        run: |
          # Map internal type names to actual label names
          case "$TYPE" in
            bugfix) DISPLAY_TYPE="bug" ;;
            feature) DISPLAY_TYPE="feature" ;;
            docs) DISPLAY_TYPE="docs" ;;
            *) DISPLAY_TYPE="$TYPE" ;;
          esac
          
          {
            echo "## Categorization updated"
            echo ""
            echo "Labels have been updated. Current classification: \`type/$DISPLAY_TYPE\` (size: $SIZE)"
            echo ""
            echo "The appropriate validation workflow will now run for this PR."
          } > /tmp/update-comment.md
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body-file /tmp/update-comment.md
          echo "Posted label update confirmation"

