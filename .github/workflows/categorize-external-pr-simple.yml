name: Categorize External PR (Simple)

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited

permissions:
  pull-requests: write
  contents: read

jobs:
  categorize:
    name: Categorize PR by Size and Type
    # Only run for your collaborator bot account, not random external PRs
    if: github.event.pull_request.user.login == 'hello-joshua'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            .github/actions
            .github/scripts
          sparse-checkout-cone-mode: false
          persist-credentials: false

      - name: Categorize PR
        id: categorize
        uses: ./.github/actions/categorize-pr
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-body: ${{ github.event.pull_request.body }}
          openai-api-key: ${{ secrets.OPEN_AI_KEY }}

      - name: Debug categorization output
        run: |
          echo "size=${{ steps.categorize.outputs.size }}"
          echo "size-label=${{ steps.categorize.outputs.size-label }}"
          echo "type=${{ steps.categorize.outputs.type }}"
          echo "type-label=${{ steps.categorize.outputs.type-label }}"

      - name: Apply labels
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SIZE_LABEL: ${{ steps.categorize.outputs.size-label }}
          TYPE_LABEL: ${{ steps.categorize.outputs.type-label }}
        run: |
          # Validate labels are set
          if [ -z "$SIZE_LABEL" ] || [ -z "$TYPE_LABEL" ]; then
            echo "ERROR: Labels not set. SIZE_LABEL='$SIZE_LABEL', TYPE_LABEL='$TYPE_LABEL'"
            exit 1
          fi
          
          echo "Will apply: $SIZE_LABEL, $TYPE_LABEL"
          
          # Remove old category and size labels before applying new ones
          existing_labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          
          for label in $existing_labels; do
            if [[ "$label" =~ ^(pr-category:|size:) ]]; then
              echo "Removing old label: $label"
              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --remove-label "$label" || true
            fi
          done
          
          # Apply new labels
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$SIZE_LABEL"
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$TYPE_LABEL"
          echo "Applied labels: $SIZE_LABEL, $TYPE_LABEL"

      - name: Post automated comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/post-pr-comment.sh
          .github/scripts/post-pr-comment.sh \
            "${{ github.event.pull_request.number }}" \
            "${{ steps.categorize.outputs.size }}" \
            "${{ steps.categorize.outputs.type }}" \
            "${{ github.repository }}"
          echo "PR categorized and comment posted"

      - name: Post classification disagreement warning
        if: steps.categorize.outputs.disagreement == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          LABEL_TYPE: ${{ steps.categorize.outputs.disagreement-label }}
          AI_TYPE: ${{ steps.categorize.outputs.disagreement-ai }}
        run: |
          cat > /tmp/disagreement-warning.md << 'EOF'
## Type Classification Disagreement

Our AI analysis suggests a different classification than the existing label:

| Source | Classification |
|--------|----------------|
| Existing label | `type/LABEL_TYPE` (currently applied) |
| AI analysis | `type/AI_TYPE` |

**What this means:**
- The existing label will be kept (safer default)
- This is informational for maintainer awareness
- AI analyzed: title, description, and changed files

**Action:** If AI is correct, update label to `type/AI_TYPE`

This check helps catch labeling errors from the pr-commands automation or race conditions.
EOF
          
          sed -i "s/LABEL_TYPE/$LABEL_TYPE/g" /tmp/disagreement-warning.md
          sed -i "s/AI_TYPE/$AI_TYPE/g" /tmp/disagreement-warning.md
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body-file /tmp/disagreement-warning.md
          echo "Posted disagreement warning for PR #$PR_NUMBER"

