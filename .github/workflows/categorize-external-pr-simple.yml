name: Categorize External PR (Simple)

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited
      - labeled

permissions:
  pull-requests: write
  contents: read

jobs:
  categorize:
    name: Categorize PR by Size and Type
    # Only run for your collaborator bot account, not random external PRs
    if: github.event.pull_request.user.login == 'hello-joshua'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          sparse-checkout: |
            .github/actions
            .github/scripts
          sparse-checkout-cone-mode: false
          persist-credentials: false

      - name: Categorize PR
        id: categorize
        uses: ./.github/actions/categorize-pr
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-body: ${{ github.event.pull_request.body }}
          openai-api-key: ${{ secrets.OPEN_AI_KEY }}

      - name: Debug categorization output
        run: |
          echo "size=${{ steps.categorize.outputs.size }}"
          echo "size-label=${{ steps.categorize.outputs.size-label }}"
          echo "type=${{ steps.categorize.outputs.type }}"
          echo "type-label=${{ steps.categorize.outputs.type-label }}"

      - name: Apply labels
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SIZE_LABEL: ${{ steps.categorize.outputs.size-label }}
          TYPE_LABEL: ${{ steps.categorize.outputs.type-label }}
        run: |
          # Validate labels are set
          if [ -z "$SIZE_LABEL" ] || [ -z "$TYPE_LABEL" ]; then
            echo "ERROR: Labels not set. SIZE_LABEL='$SIZE_LABEL', TYPE_LABEL='$TYPE_LABEL'"
            exit 1
          fi
          
          echo "Will apply: $SIZE_LABEL, $TYPE_LABEL"
          
          # Remove old category and size labels before applying new ones
          existing_labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          
          for label in $existing_labels; do
            if [[ "$label" =~ ^(pr-category:|size:|type/bug$|type/feature$|type/docs$) ]]; then
              echo "Removing old label: $label"
              gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --remove-label "$label" || true
            fi
          done
          
          # Apply new labels
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$SIZE_LABEL"
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$TYPE_LABEL"
          echo "Applied labels: $SIZE_LABEL, $TYPE_LABEL"

      - name: Post automated comment
        if: github.event.action != 'labeled'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/post-pr-comment.sh
          .github/scripts/post-pr-comment.sh \
            "${{ github.event.pull_request.number }}" \
            "${{ steps.categorize.outputs.size }}" \
            "${{ steps.categorize.outputs.type }}" \
            "${{ github.repository }}"
          echo "PR categorized and comment posted"

      - name: Post label correction confirmation
        if: github.event.action == 'labeled' && steps.categorize.outputs.disagreement == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          TYPE: ${{ steps.categorize.outputs.type }}
          SIZE: ${{ steps.categorize.outputs.size }}
        run: |
          # Map internal type names to actual label names
          case "$TYPE" in
            bugfix) DISPLAY_TYPE="bug" ;;
            feature) DISPLAY_TYPE="feature" ;;
            docs) DISPLAY_TYPE="docs" ;;
            *) DISPLAY_TYPE="$TYPE" ;;
          esac
          
          # Check for multiple type labels
          all_labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name')
          type_labels=$(echo "$all_labels" | grep -E "^type/(bug|feature|docs)$" || true)
          type_count=$(echo "$type_labels" | grep -v '^$' | wc -l)
          
          {
            echo "## Label updated"
            echo ""
            echo "The type label has been updated and now matches our AI classification."
            echo ""
            echo "Current classification: \`type/$DISPLAY_TYPE\` (size: $SIZE)"
            echo ""
            
            if [ "$type_count" -gt 1 ]; then
              echo "**Note:** Multiple type labels detected. Please remove conflicting labels to avoid confusion:"
              echo ""
              echo "$type_labels" | while read -r label; do
                if [ -n "$label" ]; then
                  # Check if this is NOT the correct label based on TYPE
                  case "$TYPE" in
                    bugfix)
                      if [ "$label" != "type/bug" ]; then
                        echo "- Remove: \`$label\`"
                      fi
                      ;;
                    feature)
                      if [ "$label" != "type/feature" ]; then
                        echo "- Remove: \`$label\`"
                      fi
                      ;;
                    docs)
                      if [ "$label" != "type/docs" ]; then
                        echo "- Remove: \`$label\`"
                      fi
                      ;;
                  esac
                fi
              done
              echo ""
            fi
            
            echo "The PR will now follow the appropriate validation workflow for this type and size."
          } > /tmp/correction-comment.md
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body-file /tmp/correction-comment.md
          echo "Posted label correction confirmation"

      - name: Post classification disagreement warning
        if: steps.categorize.outputs.disagreement == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          LABEL_TYPE: ${{ steps.categorize.outputs.disagreement-label }}
          AI_TYPE: ${{ steps.categorize.outputs.disagreement-ai }}
        run: |
          # Map internal type names to actual label names
          case "$LABEL_TYPE" in
            bugfix) DISPLAY_LABEL="bug" ;;
            feature) DISPLAY_LABEL="feature" ;;
            docs) DISPLAY_LABEL="docs" ;;
            *) DISPLAY_LABEL="$LABEL_TYPE" ;;
          esac
          
          case "$AI_TYPE" in
            bugfix) DISPLAY_AI="bug" ;;
            feature) DISPLAY_AI="feature" ;;
            docs) DISPLAY_AI="docs" ;;
            *) DISPLAY_AI="$AI_TYPE" ;;
          esac
          
          {
            echo "## Type classification disagreement"
            echo ""
            echo "Our AI analysis suggests a different classification than the existing label:"
            echo ""
            echo "Existing label: \`type/$DISPLAY_LABEL\` (currently applied)"
            echo "AI suggestion: \`type/$DISPLAY_AI\`"
            echo ""
            echo "What this means:"
            echo "- The existing label will be kept (safer default)"
            echo "- This is informational for maintainer awareness"
            echo "- AI analyzed: title, description, and changed files"
            echo ""
            echo "Action: If AI is correct, update label to \`type/$DISPLAY_AI\`"
            echo ""
            echo "This check helps catch labeling errors to ensure the PR gets into the right validation workflow."
          } > /tmp/disagreement-warning.md
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body-file /tmp/disagreement-warning.md
          echo "Posted disagreement warning for PR #$PR_NUMBER"

