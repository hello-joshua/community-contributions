name: Categorize External PR (Simple)

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited

permissions:
  pull-requests: write
  contents: read

jobs:
  categorize:
    name: Categorize PR by Size and Type
    if: github.event.pull_request.author_association != 'MEMBER' && github.event.pull_request.author_association != 'OWNER'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Categorize PR
        id: categorize
        uses: ./.github/actions/categorize-pr
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-body: ${{ github.event.pull_request.body }}

      - name: Apply labels
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SIZE_LABEL: ${{ steps.categorize.outputs.size-label }}
          TYPE_LABEL: ${{ steps.categorize.outputs.type-label }}
        run: |
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$SIZE_LABEL"
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "$TYPE_LABEL"
          echo "✅ Applied labels: $SIZE_LABEL, $TYPE_LABEL"

      - name: Post automated comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          chmod +x .github/scripts/post-pr-comment.sh
          .github/scripts/post-pr-comment.sh \
            "${{ github.event.pull_request.number }}" \
            "${{ steps.categorize.outputs.size }}" \
            "${{ steps.categorize.outputs.type }}" \
            "${{ github.repository }}"
          echo "✅ PR categorized and comment posted"

