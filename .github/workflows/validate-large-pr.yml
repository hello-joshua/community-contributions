name: Validate Large PR

on:
  workflow_run:
    workflows: 
      - "Categorize External PR (Simple)"
      - "Lint Frontend"
      - "golangci-lint"
      - "Backend Unit Tests"
      - "Frontend tests"
      - "Documentation CI"
    types:
      - completed
  pull_request_target:
    types:
      - labeled
      - synchronize

# Prevent duplicate runs for the same PR
concurrency:
  group: validate-large-pr-${{ github.event.workflow_run.head_branch || github.event.pull_request.head.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

jobs:
  early-alignment:
    name: Request Early Human Alignment
    # Only run for external PRs when size:large label applied AND alignment-approved NOT present
    if: |
      (github.event.workflow_run.conclusion == 'success' || github.event_name == 'pull_request_target')
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number and check labels
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            pr_number=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
              --jq '.pull_requests[0].number')
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            labels=$(gh pr view "$pr_number" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
            if echo "$labels" | grep -q "size:large" && ! echo "$labels" | grep -q "alignment-approved"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:large label and needs alignment"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number doesn't need early alignment, skipping"
            fi
          else
            pr_number="${{ github.event.pull_request.number }}"
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            labels="${{ join(github.event.pull_request.labels.*.name, ',') }}"
            if echo "$labels" | grep -q "size:large" && ! echo "$labels" | grep -q "alignment-approved"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:large label and needs alignment"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number doesn't need early alignment, skipping"
            fi
          fi

      - name: Detect PR type
        id: detect-type
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        run: |
          # Get PR labels
          labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
          
          # Detect type from labels
          if echo "$labels" | grep -q "type/docs"; then
            PR_TYPE="docs"
          elif echo "$labels" | grep -q "type/bug"; then
            PR_TYPE="bugfix"
          elif echo "$labels" | grep -q "type/feature"; then
            PR_TYPE="feature"
          else
            # Default to feature if no type label
            PR_TYPE="feature"
          fi
          
          echo "pr-type=$PR_TYPE" >> "$GITHUB_OUTPUT"
          echo "Detected PR type: $PR_TYPE"

      - name: Checkout repository
        if: steps.pr-info.outputs.should-run == 'true'
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Post alignment request comment
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
          PR_TYPE: ${{ steps.detect-type.outputs.pr-type }}
        run: |
          # Type-specific alignment messages
          case "$PR_TYPE" in
            docs)
              TYPE_EMOJI="ðŸ“"
              TYPE_NAME="Documentation"
              ALIGNMENT_FOCUS="Let's align on the documentation structure and organization before detailed review."
              ;;
            bugfix)
              TYPE_EMOJI="ðŸ›"
              TYPE_NAME="Bugfix"
              ALIGNMENT_FOCUS="This is a significant fix. Let's ensure the approach is sound before detailed validation."
              ;;
            feature)
              TYPE_EMOJI="âœ¨"
              TYPE_NAME="Feature"
              ALIGNMENT_FOCUS="Significant feature! Let's align on the implementation approach before going deep."
              ;;
          esac
          
          # Build comment using printf to avoid YAML heredoc issues
          printf "## %s Large %s PR - Early Alignment Required\n\n" "$TYPE_EMOJI" "$TYPE_NAME" > /tmp/alignment-comment.md
          printf "Thank you for this substantial contribution!\n\n" >> /tmp/alignment-comment.md
          printf "### Why early alignment?\n\n" >> /tmp/alignment-comment.md
          printf "For large PRs, we request early human review **before** running extensive automated validation. This helps:\n" >> /tmp/alignment-comment.md
          printf "- Ensure the approach aligns with project goals\n" >> /tmp/alignment-comment.md
          printf "- Avoid wasted effort on misaligned implementations\n" >> /tmp/alignment-comment.md
          printf "- Provide early feedback to guide your work\n" >> /tmp/alignment-comment.md
          printf "- Save everyone time!\n\n" >> /tmp/alignment-comment.md
          printf "### %s\n\n" "$ALIGNMENT_FOCUS" >> /tmp/alignment-comment.md
          printf "### Next steps:\n\n" >> /tmp/alignment-comment.md
          printf "**For you (the contributor):**\n" >> /tmp/alignment-comment.md
          printf "1. Please wait for a squad member to review the approach\n" >> /tmp/alignment-comment.md
          printf "2. Be ready to discuss the implementation strategy\n" >> /tmp/alignment-comment.md
          printf "3. Feel free to add high-level notes about your approach\n\n" >> /tmp/alignment-comment.md
          printf "**For squad members:**\n" >> /tmp/alignment-comment.md
          printf "1. Please review this PR for alignment\n" >> /tmp/alignment-comment.md
          printf "2. Discuss the approach with the contributor\n" >> /tmp/alignment-comment.md
          printf "3. Once aligned, add the \`alignment-approved\` label\n\n" >> /tmp/alignment-comment.md
          printf "---\n\n" >> /tmp/alignment-comment.md
          printf "A squad notification has been sent. Thank you for your patience!\n\n" >> /tmp/alignment-comment.md
          printf "*This is part of our large PR workflow to ensure early alignment and efficient collaboration.*\n" >> /tmp/alignment-comment.md
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body-file /tmp/alignment-comment.md
          echo "âœ… Posted alignment request comment"

      - name: Add awaiting-alignment label
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        run: |
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --add-label "awaiting-alignment"
          echo "Added awaiting-alignment label"

      - name: Notify squad for early alignment
        if: steps.pr-info.outputs.should-run == 'true'
        uses: ./.github/actions/notify-squad
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-title: ''
          pr-author: ''
          pr-url: ''
          category-size: large
          category-type: ${{ steps.detect-type.outputs.pr-type }}
          stage: early-alignment
          validation-status: pending
          ai-review-summary: Awaiting early human alignment before automated validation

  automated-validation:
    name: Large PR Automated Validation
    # Only run when both size:large AND alignment-approved labels are present
    if: |
      contains(github.event.pull_request.labels.*.name, 'size:large') &&
      contains(github.event.pull_request.labels.*.name, 'alignment-approved')
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr_number="${{ github.event.pull_request.number }}"
          echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "PR #$pr_number"

      - name: Detect PR type
        id: detect-type
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        run: |
          # Get PR labels
          labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
          
          # Detect type from labels
          if echo "$labels" | grep -q "type/docs"; then
            PR_TYPE="docs"
          elif echo "$labels" | grep -q "type/bug"; then
            PR_TYPE="bugfix"
          elif echo "$labels" | grep -q "type/feature"; then
            PR_TYPE="feature"
          else
            # Default to feature if no type label
            PR_TYPE="feature"
          fi
          
          echo "pr-type=$PR_TYPE" >> "$GITHUB_OUTPUT"
          echo "Detected PR type: $PR_TYPE"

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Remove awaiting-alignment label
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        run: |
          gh pr edit "$PR_NUMBER" --repo ${{ github.repository }} --remove-label "awaiting-alignment" || true
          echo "âœ… Removed awaiting-alignment label"

      - name: Monitor existing workflows
        id: monitor-workflows
        uses: ./.github/actions/external-pr-validation/monitor-workflows
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}

      - name: Run AI quality assessment
        id: ai-assessment
        uses: ./.github/actions/external-pr-validation/assess-quality
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}
          pr-size: large
          openai-api-key: ${{ secrets.OPEN_AI_KEY }}

      - name: Post validation comment
        uses: ./.github/actions/external-pr-validation/post-validation-comment
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}
          pr-size: large
          workflow-results: ${{ steps.monitor-workflows.outputs.results-json }}
          workflow-summary: ${{ steps.monitor-workflows.outputs.summary-text }}
          ai-feedback: ${{ steps.ai-assessment.outputs.feedback-text }}
          template-path: .github/templates/todos-large.md

      - name: Notify squad about validation completion
        if: steps.monitor-workflows.outputs.all-passed == 'true'
        uses: ./.github/actions/notify-squad
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-title: ''
          pr-author: ''
          pr-url: ''
          category-size: large
          category-type: ${{ steps.detect-type.outputs.pr-type }}
          stage: ready-for-review
          validation-status: passed
          ai-review-summary: ${{ steps.ai-assessment.outputs.summary }}

      - name: Set status check
        env:
          ALL_PASSED: ${{ steps.monitor-workflows.outputs.all-passed }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            echo "Post-alignment validation passed - ready for detailed review"
          else
            echo "Some workflows still running or failed - check validation comment for status"
            echo "Note: This validation workflow succeeds to allow iterative feedback"
          fi
          # Always exit 0 so we don't block the PR with red X while workflows are running
          exit 0

