name: Validate Small PR

on:
  pull_request_target:
    types:
      - labeled
      - synchronize

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

jobs:
  validate:
    name: Small PR Validation
    # Only run when size:small label is applied
    if: contains(github.event.pull_request.labels.*.name, 'size:small')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Detect changed areas
        id: detect-areas
        uses: ./.github/actions/detect-areas
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}

      - name: Check PR requirements
        id: check-requirements
        uses: ./.github/actions/check-requirements
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}

      - name: Verify tests exist
        id: verify-tests
        uses: ./.github/actions/verify-tests
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}

      - name: Run linting checks
        id: lint
        continue-on-error: true
        run: |
          # Determine which linting to run based on detected areas
          AREAS="${{ steps.detect-areas.outputs.areas }}"
          lint_failed=false
          
          if echo "$AREAS" | grep -q "frontend"; then
            echo "Running frontend linting..."
            if command -v yarn &> /dev/null; then
              yarn install --immutable || lint_failed=true
              yarn lint || lint_failed=true
            else
              echo "‚ö†Ô∏è yarn not found, skipping frontend lint"
            fi
          fi
          
          if echo "$AREAS" | grep -q "backend"; then
            echo "Running backend linting..."
            if command -v go &> /dev/null; then
              go fmt ./... || lint_failed=true
              go vet ./... || lint_failed=true
            else
              echo "‚ö†Ô∏è go not found, skipping backend lint"
            fi
          fi
          
          if [ "$lint_failed" = true ]; then
            echo "lint-passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "lint-passed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run relevant tests
        id: tests
        continue-on-error: true
        run: |
          # Run tests for changed areas
          AREAS="${{ steps.detect-areas.outputs.areas }}"
          tests_failed=false
          
          if echo "$AREAS" | grep -q "frontend"; then
            echo "Running frontend tests..."
            if command -v yarn &> /dev/null && [ -f "package.json" ]; then
              # Run only tests for changed files
              yarn test:ci || tests_failed=true
            else
              echo "‚ö†Ô∏è Skipping frontend tests"
            fi
          fi
          
          if echo "$AREAS" | grep -q "backend"; then
            echo "Running backend tests..."
            if command -v go &> /dev/null; then
              # Run short tests only for small PRs
              go test -short ./... || tests_failed=true
            else
              echo "‚ö†Ô∏è Skipping backend tests"
            fi
          fi
          
          if [ "$tests_failed" = true ]; then
            echo "tests-passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "tests-passed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Evaluate validation results
        id: evaluate
        shell: bash
        env:
          REQUIREMENTS_MET: ${{ steps.check-requirements.outputs.all-requirements-met }}
          TESTS_EXIST: ${{ steps.verify-tests.outputs.tests-exist }}
          LINT_PASSED: ${{ steps.lint.outputs.lint-passed }}
          TESTS_PASSED: ${{ steps.tests.outputs.tests-passed }}
        run: |
          all_passed=true
          
          if [ "$REQUIREMENTS_MET" != "true" ]; then all_passed=false; fi
          if [ "$TESTS_EXIST" != "true" ]; then all_passed=false; fi
          if [ "$LINT_PASSED" != "true" ]; then all_passed=false; fi
          if [ "$TESTS_PASSED" != "true" ]; then all_passed=false; fi
          
          echo "all-passed=$all_passed" >> "$GITHUB_OUTPUT"

      - name: Post validation results
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ALL_PASSED: ${{ steps.evaluate.outputs.all-passed }}
          REQUIREMENTS_MET: ${{ steps.check-requirements.outputs.all-requirements-met }}
          MISSING_REQUIREMENTS: ${{ steps.check-requirements.outputs.missing-requirements }}
          TESTS_EXIST: ${{ steps.verify-tests.outputs.tests-exist }}
          MISSING_TESTS: ${{ steps.verify-tests.outputs.missing-tests }}
          LINT_PASSED: ${{ steps.lint.outputs.lint-passed }}
          TESTS_PASSED: ${{ steps.tests.outputs.tests-passed }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            COMMENT="## ‚úÖ Small PR Validation Passed

All automated checks have passed! Your PR is ready for AI code review.

### Validation Results:
- ‚úÖ PR requirements met
- ‚úÖ Tests exist for changed code
- ‚úÖ Linting checks passed
- ‚úÖ Test suite passed

**Next steps:**
1. ü§ñ Cursor's Bugbot will review your code shortly
2. üë§ A human reviewer will provide final approval
3. ‚ö° Small PRs typically have faster turnaround times

Thank you for your contribution!"
          else
            COMMENT="## ‚ö†Ô∏è Small PR Validation - Action Required

Some automated checks did not pass. Please address the following:

### Validation Results:"
            
            if [ "$REQUIREMENTS_MET" = "true" ]; then
              COMMENT="$COMMENT
- ‚úÖ PR requirements met"
            else
              COMMENT="$COMMENT
- ‚ùå **PR requirements not met:**
\`\`\`
$MISSING_REQUIREMENTS
\`\`\`"
            fi
            
            if [ "$TESTS_EXIST" = "true" ]; then
              COMMENT="$COMMENT
- ‚úÖ Tests exist for changed code"
            else
              COMMENT="$COMMENT
- ‚ùå **Missing tests for:**
\`\`\`
$MISSING_TESTS
\`\`\`
Please add test files following these patterns:
  - Frontend: \`filename.test.ts\` or \`filename.spec.ts\`
  - Backend: \`filename_test.go\`"
            fi
            
            if [ "$LINT_PASSED" = "true" ]; then
              COMMENT="$COMMENT
- ‚úÖ Linting checks passed"
            else
              COMMENT="$COMMENT
- ‚ùå **Linting checks failed** - Please run linting locally and fix issues"
            fi
            
            if [ "$TESTS_PASSED" = "true" ]; then
              COMMENT="$COMMENT
- ‚úÖ Test suite passed"
            else
              COMMENT="$COMMENT
- ‚ùå **Tests failed** - Please ensure all tests pass locally"
            fi
            
            COMMENT="$COMMENT

### How to fix:
1. Address the issues listed above
2. Push your changes - validation will run automatically
3. See [Contributing Guidelines](../contribute/create-pull-request.md) for details

*This is an automated validation for Small PRs.*"
          fi
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"

      - name: Notify squad if validation passed
        if: steps.evaluate.outputs.all-passed == 'true'
        uses: ./.github/actions/notify-squad
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ github.event.pull_request.number }}
          pr-title: ${{ github.event.pull_request.title }}
          pr-author: ${{ github.event.pull_request.user.login }}
          pr-url: ${{ github.event.pull_request.html_url }}
          category-size: small
          category-type: ${{ steps.detect-areas.outputs.primary-area }}
          stage: validation-passed
          validation-status: passed
          ai-review-summary: Ready for lightweight AI review

      - name: Set status check
        env:
          GH_TOKEN: ${{ github.token }}
          ALL_PASSED: ${{ steps.evaluate.outputs.all-passed }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            echo "‚úÖ Validation passed - ready for AI review - Squad notified"
            exit 0
          else
            echo "‚ùå Validation failed - action required"
            exit 1
          fi

