name: Validate Medium PR

on:
  workflow_run:
    workflows: ["Categorize External PR (Simple)"]
    types:
      - completed
  pull_request_target:
    types:
      - synchronize

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

jobs:
  validate:
    name: Medium PR Validation
    # Only run for external PRs and when categorization succeeded
    if: |
      (github.event.workflow_run.conclusion == 'success' || github.event_name == 'pull_request_target') &&
      (github.event.pull_request.author_association != 'MEMBER' && github.event.pull_request.author_association != 'OWNER' || github.event_name == 'workflow_run')
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number and check labels
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get PR number from workflow_run event
            pr_number=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
              --jq '.pull_requests[0].number')
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            # Check if PR has size:medium label
            labels=$(gh pr view "$pr_number" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
            if echo "$labels" | grep -q "size:medium"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:medium label"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number does not have size:medium label, skipping"
            fi
          else
            # pull_request_target event (synchronize)
            pr_number="${{ github.event.pull_request.number }}"
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            labels="${{ join(github.event.pull_request.labels.*.name, ',') }}"
            if echo "$labels" | grep -q "size:medium"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:medium label"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number does not have size:medium label, skipping"
            fi
          fi

      - name: Checkout repository
        if: steps.pr-info.outputs.should-run == 'true'
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Detect changed areas
        if: steps.pr-info.outputs.should-run == 'true'
        id: detect-areas
        uses: ./.github/actions/detect-areas
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}

      - name: Check PR requirements
        if: steps.pr-info.outputs.should-run == 'true'
        id: check-requirements
        uses: ./.github/actions/check-requirements
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}

      - name: Verify tests exist
        if: steps.pr-info.outputs.should-run == 'true'
        id: verify-tests
        uses: ./.github/actions/verify-tests
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}

      - name: Run comprehensive linting
        if: steps.pr-info.outputs.should-run == 'true'
        id: lint
        continue-on-error: true
        run: |
          AREAS="${{ steps.detect-areas.outputs.areas }}"
          lint_failed=false
          
          if echo "$AREAS" | grep -q "frontend"; then
            echo "Running comprehensive frontend linting..."
            if command -v yarn &> /dev/null; then
              yarn install --immutable || lint_failed=true
              yarn lint || lint_failed=true
              yarn typecheck || lint_failed=true
            else
              echo "WARNING: yarn not found, skipping frontend lint"
            fi
          fi
          
          if echo "$AREAS" | grep -q "backend"; then
            echo "Running comprehensive backend linting..."
            if command -v go &> /dev/null; then
              go fmt ./... || lint_failed=true
              go vet ./... || lint_failed=true
              # Run golangci-lint if available
              if command -v golangci-lint &> /dev/null; then
                golangci-lint run || lint_failed=true
              fi
            else
              echo "WARNING: go not found, skipping backend lint"
            fi
          fi
          
          if [ "$lint_failed" = true ]; then
            echo "lint-passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "lint-passed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run comprehensive tests
        if: steps.pr-info.outputs.should-run == 'true'
        id: tests
        continue-on-error: true
        run: |
          AREAS="${{ steps.detect-areas.outputs.areas }}"
          tests_failed=false
          
          if echo "$AREAS" | grep -q "frontend"; then
            echo "Running comprehensive frontend tests..."
            if command -v yarn &> /dev/null && [ -f "package.json" ]; then
              yarn test:ci || tests_failed=true
            else
              echo "WARNING: Skipping frontend tests"
            fi
          fi
          
          if echo "$AREAS" | grep -q "backend"; then
            echo "Running comprehensive backend tests..."
            if command -v go &> /dev/null; then
              # Run full test suite for medium PRs
              go test -timeout=30m ./... || tests_failed=true
            else
              echo "WARNING: Skipping backend tests"
            fi
          fi
          
          if [ "$tests_failed" = true ]; then
            echo "tests-passed=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "tests-passed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Evaluate validation results
        if: steps.pr-info.outputs.should-run == 'true'
        id: evaluate
        shell: bash
        env:
          REQUIREMENTS_MET: ${{ steps.check-requirements.outputs.all-requirements-met }}
          TESTS_EXIST: ${{ steps.verify-tests.outputs.tests-exist }}
          LINT_PASSED: ${{ steps.lint.outputs.lint-passed }}
          TESTS_PASSED: ${{ steps.tests.outputs.tests-passed }}
        run: |
          all_passed=true
          
          if [ "$REQUIREMENTS_MET" != "true" ]; then all_passed=false; fi
          if [ "$TESTS_EXIST" != "true" ]; then all_passed=false; fi
          if [ "$LINT_PASSED" != "true" ]; then all_passed=false; fi
          if [ "$TESTS_PASSED" != "true" ]; then all_passed=false; fi
          
          echo "all-passed=$all_passed" >> "$GITHUB_OUTPUT"

      - name: Post validation results
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
          ALL_PASSED: ${{ steps.evaluate.outputs.all-passed }}
          REQUIREMENTS_MET: ${{ steps.check-requirements.outputs.all-requirements-met }}
          MISSING_REQUIREMENTS: ${{ steps.check-requirements.outputs.missing-requirements }}
          TESTS_EXIST: ${{ steps.verify-tests.outputs.tests-exist }}
          MISSING_TESTS: ${{ steps.verify-tests.outputs.missing-tests }}
          LINT_PASSED: ${{ steps.lint.outputs.lint-passed }}
          TESTS_PASSED: ${{ steps.tests.outputs.tests-passed }}
          AREAS: ${{ steps.detect-areas.outputs.areas }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            COMMENT="## Medium PR Validation Passed

All comprehensive automated checks have passed! Your PR is ready for thorough AI code review.

### Validation Results:
- PR requirements met
- Tests exist for changed code
- Comprehensive linting checks passed
- Full test suite passed
- Affected areas: \`$AREAS\`

**Next steps:**
1. Cursor's Bugbot will perform thorough code review
2. Your PR will be routed to the relevant squad
3. Human review required before merge

This PR has been categorized as Medium size, which means it will receive comprehensive validation and review.

Thank you for your contribution!"
          else
            COMMENT="## WARNING: Medium PR Validation - Action Required

Some comprehensive automated checks did not pass. Please address the following:

### Validation Results:"
            
            if [ "$REQUIREMENTS_MET" = "true" ]; then
              COMMENT="$COMMENT
- PR requirements met"
            else
              COMMENT="$COMMENT
- **PR requirements not met:**
\`\`\`
$MISSING_REQUIREMENTS
\`\`\`"
            fi
            
            if [ "$TESTS_EXIST" = "true" ]; then
              COMMENT="$COMMENT
- Tests exist for changed code"
            else
              COMMENT="$COMMENT
- **Missing tests for:**
\`\`\`
$MISSING_TESTS
\`\`\`
Please add comprehensive test coverage for all changes."
            fi
            
            if [ "$LINT_PASSED" = "true" ]; then
              COMMENT="$COMMENT
- Comprehensive linting checks passed"
            else
              COMMENT="$COMMENT
- **Linting checks failed** - Please run linting locally and fix all issues"
            fi
            
            if [ "$TESTS_PASSED" = "true" ]; then
              COMMENT="$COMMENT
- Full test suite passed"
            else
              COMMENT="$COMMENT
- **Tests failed** - Please ensure all tests pass locally"
            fi
            
            COMMENT="$COMMENT

### How to fix:
1. Address the issues listed above
2. Push your changes - validation will run automatically
3. See [Contributing Guidelines](../contribute/create-pull-request.md) for details

**Note**: Medium PRs undergo comprehensive validation including full test suites and thorough linting.

*This is an automated validation for Medium PRs.*"
          fi
          
          gh pr comment "$PR_NUMBER" --repo ${{ github.repository }} --body "$COMMENT"

      - name: Notify squad if validation passed
        if: steps.pr-info.outputs.should-run == 'true' && steps.evaluate.outputs.all-passed == 'true'
        uses: ./.github/actions/notify-squad
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          category-size: medium
          category-type: ${{ steps.detect-areas.outputs.primary-area }}
          stage: validation-passed
          validation-status: passed
          ai-review-summary: Ready for thorough AI review

      - name: Set status check
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          ALL_PASSED: ${{ steps.evaluate.outputs.all-passed }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            echo "Comprehensive validation passed - ready for AI review and squad routing - Squad notified"
            exit 0
          else
            echo "Validation failed - action required"
            exit 1
          fi

