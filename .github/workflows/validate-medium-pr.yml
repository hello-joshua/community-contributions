name: Validate Medium PR

on:
  workflow_run:
    workflows: ["Categorize External PR (Simple)"]
    types:
      - completed
  pull_request_target:
    types:
      - synchronize

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

jobs:
  validate:
    name: Medium PR Validation
    # Only run for external PRs and when categorization succeeded
    if: |
      (github.event.workflow_run.conclusion == 'success' || github.event_name == 'pull_request_target') &&
      (github.event.pull_request.author_association != 'MEMBER' && github.event.pull_request.author_association != 'OWNER' || github.event_name == 'workflow_run')
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number and check labels
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get PR number from workflow_run event
            pr_number=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
              --jq '.pull_requests[0].number')
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            # Check if PR has size:medium label
            labels=$(gh pr view "$pr_number" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
            if echo "$labels" | grep -q "size:medium"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:medium label"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number does not have size:medium label, skipping"
            fi
          else
            # pull_request_target event (synchronize)
            pr_number="${{ github.event.pull_request.number }}"
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            labels="${{ join(github.event.pull_request.labels.*.name, ',') }}"
            if echo "$labels" | grep -q "size:medium"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:medium label"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number does not have size:medium label, skipping"
            fi
          fi

      - name: Detect PR type
        id: detect-type
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        run: |
          # Get PR labels
          labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
          
          # Detect type from labels
          if echo "$labels" | grep -q "type/docs"; then
            PR_TYPE="docs"
          elif echo "$labels" | grep -q "type/bug"; then
            PR_TYPE="bugfix"
          elif echo "$labels" | grep -q "type/feature"; then
            PR_TYPE="feature"
          else
            # Default to feature if no type label
            PR_TYPE="feature"
          fi
          
          echo "pr-type=$PR_TYPE" >> "$GITHUB_OUTPUT"
          echo "Detected PR type: $PR_TYPE"
      
      - name: Checkout repository
        if: steps.pr-info.outputs.should-run == 'true'
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Monitor existing workflows
        if: steps.pr-info.outputs.should-run == 'true'
        id: monitor-workflows
        uses: ./.github/actions/external-pr-validation/monitor-workflows
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}

      - name: Run AI quality assessment
        if: steps.pr-info.outputs.should-run == 'true'
        id: ai-assessment
        uses: ./.github/actions/external-pr-validation/assess-quality
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}
          pr-size: medium
          openai-api-key: ${{ secrets.OPEN_AI_KEY }}

      - name: Post validation comment
        if: steps.pr-info.outputs.should-run == 'true'
        uses: ./.github/actions/external-pr-validation/post-validation-comment
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}
          pr-size: medium
          workflow-results: ${{ steps.monitor-workflows.outputs.results-json }}
          workflow-summary: ${{ steps.monitor-workflows.outputs.summary-text }}
          ai-feedback: ${{ steps.ai-assessment.outputs.feedback-text }}
          template-path: .github/templates/todos-medium.md

      - name: Notify squad if workflows passed
        if: steps.pr-info.outputs.should-run == 'true' && steps.monitor-workflows.outputs.all-passed == 'true'
        uses: ./.github/actions/notify-squad
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-title: ''
          pr-author: ''
          pr-url: ''
          category-size: medium
          category-type: ${{ steps.detect-type.outputs.pr-type }}
          stage: validation-passed
          validation-status: passed
          ai-review-summary: ${{ steps.ai-assessment.outputs.summary }}

      - name: Set status check
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          ALL_PASSED: ${{ steps.monitor-workflows.outputs.all-passed }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            echo "✅ All workflows passed - validation complete"
            exit 0
          else
            echo "⚠️ Some workflows failed or pending - see validation comment for details"
            exit 1
          fi

