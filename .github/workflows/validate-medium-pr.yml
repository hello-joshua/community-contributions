name: Validate Medium PR

on:
  workflow_run:
    workflows: 
      - "Categorize External PR (Simple)"
      - "Lint Frontend"
      - "golangci-lint"
      - "Backend Unit Tests"
      - "Frontend tests"
      - "Documentation CI"
    types:
      - completed
  pull_request_target:
    types:
      - synchronize

# Prevent duplicate runs for the same PR - cancel previous runs
concurrency:
  group: validate-medium-pr-${{ github.event.workflow_run.head_branch || github.event.pull_request.head.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  statuses: write
  checks: write

jobs:
  validate:
    name: Medium PR Validation
    # Only run for external PRs and when categorization succeeded
    if: |
      (github.event.workflow_run.conclusion == 'success' || github.event_name == 'pull_request_target') &&
      (github.event.pull_request.author_association != 'MEMBER' && github.event.pull_request.author_association != 'OWNER' || github.event_name == 'workflow_run')
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number and check labels
        id: pr-info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Get PR number from workflow_run event
            # First try the pull_requests array
            pr_number=$(gh api "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
              --jq '.pull_requests[0].number // empty')
            
            # If empty, find PR by head branch
            if [ -z "$pr_number" ]; then
              echo "pull_requests array empty, finding PR by head branch..."
              head_branch="${{ github.event.workflow_run.head_branch }}"
              echo "Head branch: $head_branch"
              
              # Find the PR with this head branch
              pr_number=$(gh pr list --repo ${{ github.repository }} --state open --head "$head_branch" --json number --jq '.[0].number // empty')
              
              if [ -z "$pr_number" ]; then
                echo "No open PR found for branch $head_branch, skipping"
                echo "should-run=false" >> "$GITHUB_OUTPUT"
                echo "pr-number=" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
            
            echo "Found PR #$pr_number"
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            # Check if PR has size:medium label
            labels=$(gh pr view "$pr_number" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
            if echo "$labels" | grep -q "size:medium"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:medium label"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number does not have size:medium label, skipping"
            fi
          else
            # pull_request_target event (synchronize)
            pr_number="${{ github.event.pull_request.number }}"
            echo "pr-number=$pr_number" >> "$GITHUB_OUTPUT"
            
            labels="${{ join(github.event.pull_request.labels.*.name, ',') }}"
            if echo "$labels" | grep -q "size:medium"; then
              echo "should-run=true" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number has size:medium label"
            else
              echo "should-run=false" >> "$GITHUB_OUTPUT"
              echo "PR #$pr_number does not have size:medium label, skipping"
            fi
          fi

      - name: Detect PR type
        id: detect-type
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        run: |
          # Get PR labels
          labels=$(gh pr view "$PR_NUMBER" --repo ${{ github.repository }} --json labels --jq '.labels[].name' | tr '\n' ',')
          
          # Detect type from labels
          if echo "$labels" | grep -q "type/docs"; then
            PR_TYPE="docs"
          elif echo "$labels" | grep -q "type/bug"; then
            PR_TYPE="bugfix"
          elif echo "$labels" | grep -q "type/feature"; then
            PR_TYPE="feature"
          else
            # Default to feature if no type label
            PR_TYPE="feature"
          fi
          
          echo "pr-type=$PR_TYPE" >> "$GITHUB_OUTPUT"
          echo "Detected PR type: $PR_TYPE"
      
      - name: Checkout repository
        if: steps.pr-info.outputs.should-run == 'true'
        uses: actions/checkout@v5
        with:
          persist-credentials: false

      - name: Monitor existing workflows
        if: steps.pr-info.outputs.should-run == 'true'
        id: monitor-workflows
        uses: ./.github/actions/external-pr-validation/monitor-workflows
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}

      - name: Post validation comment
        if: steps.pr-info.outputs.should-run == 'true'
        uses: ./.github/actions/external-pr-validation/post-validation-comment
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-type: ${{ steps.detect-type.outputs.pr-type }}
          pr-size: medium
          workflow-results: ${{ steps.monitor-workflows.outputs.results-json }}
          workflow-summary: ${{ steps.monitor-workflows.outputs.summary-text }}
          template-path: .github/templates/todos-medium.md

      - name: Notify squad if workflows passed
        if: steps.pr-info.outputs.should-run == 'true' && steps.monitor-workflows.outputs.all-passed == 'true'
        uses: ./.github/actions/notify-squad
        with:
          github-token: ${{ github.token }}
          pr-number: ${{ steps.pr-info.outputs.pr-number }}
          pr-title: ''
          pr-author: ''
          pr-url: ''
          category-size: medium
          category-type: ${{ steps.detect-type.outputs.pr-type }}
          stage: validation-passed
          validation-status: passed

      - name: Set status check
        if: steps.pr-info.outputs.should-run == 'true'
        env:
          ALL_PASSED: ${{ steps.monitor-workflows.outputs.all-passed }}
        run: |
          if [ "$ALL_PASSED" = "true" ]; then
            echo "All workflows passed - validation complete"
          else
            echo "Some workflows still running or failed - check validation comment for status"
            echo "Note: This validation workflow succeeds to allow iterative feedback"
          fi
          # Always exit 0 so we don't block the PR with red X while workflows are running
          exit 0

