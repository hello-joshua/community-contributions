name: Copy External PRs

on:
  schedule:
    - cron: '*/30 * * * *'  # Every 30 minutes
  workflow_dispatch:  # Manual trigger for testing

permissions:
  contents: write
  pull-requests: write

jobs:
  copy-prs:
    name: Copy External PRs from grafana/grafana
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.PR_COPY_BOT_TOKEN }}
          persist-credentials: true

      - name: Configure Git
        run: |
          git config user.name "PR Copy Bot"
          git config user.email "bot@tonypowa.grafana"

      - name: Fetch external PRs from grafana/grafana
        id: fetch-prs
        env:
          GH_TOKEN: ${{ secrets.PR_COPY_BOT_TOKEN }}
        run: |
          # Debug: Check gh CLI version
          gh --version
          
          # Verify token is set
          if [ -z "$GH_TOKEN" ]; then
            echo "ERROR: GH_TOKEN is not set"
            exit 1
          fi
          echo "GH_TOKEN is set (length: ${#GH_TOKEN})"
          
          # Test gh authentication
          echo "Testing gh authentication..."
          gh auth status
          
          # Test basic API access to grafana/grafana
          echo "Testing API access to grafana/grafana..."
          gh api /repos/grafana/grafana --jq '.full_name'
          
          # Get PRs from last 7 days using Python for portability
          seven_days_ago=$(python3 -c "from datetime import datetime, timedelta; print((datetime.utcnow() - timedelta(days=7)).strftime('%Y-%m-%dT%H:%M:%SZ'))")
          echo "Fetching PRs created after: $seven_days_ago"
          
          # Fetch open PRs from grafana/grafana
          echo "Fetching PRs from grafana/grafana..."
          if ! gh pr list \
            --repo grafana/grafana \
            --state open \
            --limit 100 \
            --json number,title,body,author,createdAt,labels \
            > /tmp/all_prs.json; then
            echo "ERROR: gh pr list failed. Check authentication and permissions."
            exit 1
          fi
          
          # Filter PRs by date using jq with proper variable passing
          echo "Filtering PRs by date..."
          jq --arg date "$seven_days_ago" '[.[] | select(.createdAt >= $date)] | .[:20]' \
            /tmp/all_prs.json > /tmp/upstream_prs.json
          
          echo "Fetched PRs from upstream"
          cat /tmp/upstream_prs.json | jq 'length'

      - name: Filter external PRs
        id: filter
        env:
          GH_TOKEN: ${{ secrets.PR_COPY_BOT_TOKEN }}
        run: |
          # Skip authorAssociation filtering (requires org membership permissions)
          # Instead, copy all PRs and rely on manual filtering if needed
          echo "Preparing PRs for copying (no author filtering)..."
          
          # Just use the already fetched PRs
          cp /tmp/upstream_prs.json /tmp/external_prs_array.json
          
          echo "Total PRs to process:"
          cat /tmp/external_prs_array.json | jq 'length'

      - name: Load tracker and process PRs
        env:
          GH_TOKEN: ${{ secrets.PR_COPY_BOT_TOKEN }}
        run: |
          # Load tracker
          if [ ! -f .github/pr-copy-tracker.json ]; then
            echo '{"copied_prs":[],"last_check_timestamp":null}' > .github/pr-copy-tracker.json
          fi
          
          copied_prs=$(jq -r '.copied_prs[]' .github/pr-copy-tracker.json)
          
          # Process only 1 PR per run
          processed=0
          max_per_run=1
          
          while read -r pr; do
            if [ -z "$pr" ]; then continue; fi
            if [ "$processed" -ge "$max_per_run" ]; then
              echo "Reached limit of $max_per_run PRs per run"
              break
            fi
            
            pr_number=$(echo "$pr" | jq -r '.number')
            
            # Check if already copied
            if echo "$copied_prs" | grep -q "^${pr_number}$"; then
              echo "PR #$pr_number already copied, skipping"
              continue
            fi
            
            echo "Processing PR #$pr_number"
            
            # Extract PR details
            pr_title=$(echo "$pr" | jq -r '.title')
            pr_body=$(echo "$pr" | jq -r '.body // ""')
            pr_labels=$(echo "$pr" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
            
            # Create timestamp
            timestamp=$(date +%Y%m%d%H%M%S)
            branch_name="bot/copy-pr-${pr_number}-${timestamp}"
            
            # Create branch
            git checkout -b "$branch_name"
            
            # Fetch the actual PR changes from upstream
            echo "Fetching code changes from PR #${pr_number}..."
            if gh pr diff "$pr_number" --repo grafana/grafana > /tmp/pr_${pr_number}.patch; then
              echo "Applying changes..."
              
              # Try to apply the patch
              if git apply --3way /tmp/pr_${pr_number}.patch 2>&1; then
                echo "✅ Successfully applied changes from PR #${pr_number}"
                
                # Stage all changes
                git add -A
                
                # Check if there are changes to commit
                if git diff --staged --quiet; then
                  echo "⚠️  No changes to commit (patch may be empty or already applied)"
                else
                  git commit -m "Copy changes from grafana/grafana PR #${pr_number}

Original title: ${pr_title}"
                fi
              else
                echo "⚠️  Failed to apply patch cleanly. There may be conflicts."
                echo "Creating a marker file instead..."
                
                # Create a conflict marker file
                mkdir -p .github/test-data
                {
                  echo "⚠️ PATCH APPLICATION FAILED"
                  echo "Original PR: grafana/grafana #${pr_number}"
                  echo "Title: ${pr_title}"
                  echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
                  echo ""
                  echo "The patch could not be applied cleanly. Manual intervention may be required."
                } > ".github/test-data/pr-copy-${pr_number}-conflict.txt"
                
                git add .github/test-data/pr-copy-${pr_number}-conflict.txt
                git commit -m "Copy attempt for PR #${pr_number} (conflicts detected)"
              fi
            else
              echo "⚠️  Could not fetch patch for PR #${pr_number}"
              
              # Create a fallback marker file
              mkdir -p .github/test-data
              {
                echo "⚠️ PATCH FETCH FAILED"
                echo "Original PR: grafana/grafana #${pr_number}"
                echo "Title: ${pr_title}"
                echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
              } > ".github/test-data/pr-copy-${pr_number}-fetch-failed.txt"
              
              git add .github/test-data/pr-copy-${pr_number}-fetch-failed.txt
              git commit -m "Copy attempt for PR #${pr_number} (fetch failed)"
            fi
            
            # Push branch
            git push origin "$branch_name"
            
            # Create PR description file to avoid quote issues
            {
              echo "$pr_body"
              echo ""
              echo "---"
              echo ""
              echo "Automated test copy from upstream PR ${pr_number}"
            } > /tmp/pr_description.txt
            
            # Create PR with prefix
            gh pr create \
              --repo ${{ github.repository }} \
              --base main \
              --head "$branch_name" \
              --title "Ext-PR-Copy: $pr_title" \
              --body-file /tmp/pr_description.txt || echo "PR creation failed, continuing"
            
            # Update tracker
            jq --arg pr "$pr_number" '.copied_prs += [$pr | tonumber]' .github/pr-copy-tracker.json > /tmp/tracker.json
            mv /tmp/tracker.json .github/pr-copy-tracker.json
            
            processed=$((processed + 1))
            
            # Return to main branch
            git checkout main
            
            echo "✅ Copied PR #$pr_number"
            
          done < <(cat /tmp/external_prs_array.json | jq -c '.[]')
          
          echo "Processed $processed PRs"

      - name: Commit updated tracker
        run: |
          # Update timestamp
          jq --arg ts "$(date -u '+%Y-%m-%dT%H:%M:%SZ')" '.last_check_timestamp = $ts' .github/pr-copy-tracker.json > /tmp/tracker.json
          mv /tmp/tracker.json .github/pr-copy-tracker.json
          
          git add .github/pr-copy-tracker.json
          
          if git diff --staged --quiet; then
            echo "No changes to tracker"
          else
            git commit -m "Bot: Update PR copy tracker"
            git push origin main
            echo "✅ Tracker updated"
          fi

